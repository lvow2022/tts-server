<!DOCTYPE html>
<html>
<head>
    <title>TTS Server æµ‹è¯•é¡µé¢</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        input, textarea, button { margin: 5px; padding: 8px; }
        textarea { width: 100%; height: 100px; }
        button { background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .status { padding: 10px; margin: 10px 0; border-radius: 3px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .auto-check { font-size: 12px; color: #666; margin-top: 5px; }
        .chart-container { margin: 20px 0; }
        .chart { width: 100%; height: 300px; border: 1px solid #ddd; }
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .chart-section { margin: 20px 0; }
        .gpu-info { background: #e7f3ff; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .gpu-info h4 { margin: 0 0 10px 0; color: #0056b3; }
        .gpu-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .gpu-stat { background: white; padding: 8px; border-radius: 3px; text-align: center; }
        .gpu-stat .value { font-size: 18px; font-weight: bold; color: #007bff; }
        .gpu-stat .label { font-size: 12px; color: #666; }
        .system-info { background: #f0f9eb; padding: 10px; border-radius: 5px; margin-top: 20px; }
        .system-info h4 { margin: 0 0 10px 0; color: #67c23a; }
        .system-info p { margin: 5px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤ TTS Server æµ‹è¯•é¡µé¢</h1>
        
        <div class="section">
            <h3>ğŸ“Š æœåŠ¡çŠ¶æ€</h3>
            <button onclick="checkHealth()">æ£€æŸ¥å¥åº·çŠ¶æ€</button>
            <div id="healthStatus"></div>
            <div class="auto-check">â° æ¯5ç§’è‡ªåŠ¨æ£€æŸ¥æœåŠ¡çŠ¶æ€</div>
        </div>
        
        <div class="section">
            <h3>ğŸ“ˆ ç³»ç»Ÿç›‘æ§</h3>
            <div class="charts-grid">
                <div class="chart-section">
                    <h4>å†…å­˜ä½¿ç”¨è¶‹åŠ¿</h4>
                    <div class="chart-container">
                        <canvas id="memoryChart" class="chart"></canvas>
                    </div>
                </div>
                <div class="chart-section">
                    <h4>GPUæ˜¾å­˜ä½¿ç”¨è¶‹åŠ¿</h4>
                    <div class="chart-container">
                        <canvas id="gpuChart" class="chart"></canvas>
                    </div>
                </div>
            </div>
            <div class="charts-grid">
                <div class="chart-section">
                    <h4>CPUä½¿ç”¨ç‡è¶‹åŠ¿</h4>
                    <div class="chart-container">
                        <canvas id="cpuChart" class="chart"></canvas>
                    </div>
                </div>
                <div class="chart-section">
                    <h4>ç³»ç»Ÿèµ„æºæ¦‚è§ˆ</h4>
                    <div id="systemInfo" class="system-info"></div>
                </div>
            </div>
            <div id="gpuInfo" class="gpu-info" style="display: none;">
                <h4>ğŸ® GPU ä¿¡æ¯</h4>
                <div class="gpu-stats" id="gpuStats"></div>
            </div>
        </div>
        
        <div class="section">
            <h3>ğŸµ è¯­éŸ³åˆæˆæµ‹è¯•</h3>
            <textarea id="textInput" placeholder="è¯·è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬...">ä½ å¥½ï¼Œè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ã€‚</textarea>
            <br>
            <button onclick="synthesize()">åˆæˆè¯­éŸ³</button>
            <div id="synthesisResult"></div>
            <audio id="audioPlayer" controls style="display:none;"></audio>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let healthCheckInterval = null;
        let memoryHistory = []; // å­˜å‚¨å†…å­˜ä½¿ç”¨å†å²
        let gpuHistory = []; // å­˜å‚¨GPUæ˜¾å­˜ä½¿ç”¨å†å²
        let cpuHistory = []; // å­˜å‚¨CPUä½¿ç”¨ç‡å†å²
        let memoryChart = null;
        let gpuChart = null;
        let cpuChart = null;
        let isGPUAvailable = false;
        
        // åˆå§‹åŒ–å†…å­˜å›¾è¡¨
        function initMemoryChart() {
            const ctx = document.getElementById('memoryChart').getContext('2d');
            memoryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'è¿›ç¨‹å†…å­˜ä½¿ç”¨ (MB)',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }, {
                        label: 'ç³»ç»Ÿå†…å­˜ä½¿ç”¨ (MB)',
                        data: [],
                        borderColor: 'rgb(255, 159, 64)',
                        backgroundColor: 'rgba(255, 159, 64, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'å†…å­˜ä½¿ç”¨ (MB)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¶é—´'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'å†…å­˜ä½¿ç”¨è¶‹åŠ¿å›¾'
                        }
                    }
                }
            });
        }
        
        // åˆå§‹åŒ–GPUå›¾è¡¨
        function initGPUChart() {
            const ctx = document.getElementById('gpuChart').getContext('2d');
            gpuChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'GPUæ˜¾å­˜ä½¿ç”¨ (MB)',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'GPUæ˜¾å­˜ä½¿ç”¨ (MB)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¶é—´'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'GPUæ˜¾å­˜ä½¿ç”¨è¶‹åŠ¿å›¾'
                        }
                    }
                }
            });
        }
        
        // åˆå§‹åŒ–CPUå›¾è¡¨
        function initCPUChart() {
            const ctx = document.getElementById('cpuChart').getContext('2d');
            cpuChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'è¿›ç¨‹CPUä½¿ç”¨ç‡ (%)',
                        data: [],
                        borderColor: 'rgb(153, 102, 255)',
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        tension: 0.1
                    }, {
                        label: 'ç³»ç»ŸCPUä½¿ç”¨ç‡ (%)',
                        data: [],
                        borderColor: 'rgb(255, 205, 86)',
                        backgroundColor: 'rgba(255, 205, 86, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'CPUä½¿ç”¨ç‡ (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¶é—´'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'CPUä½¿ç”¨ç‡è¶‹åŠ¿å›¾'
                        }
                    }
                }
            });
        }
        
        // æ›´æ–°å†…å­˜å›¾è¡¨
        function updateMemoryChart(memoryUsage, timestamp) {
            if (!memoryChart) {
                initMemoryChart();
            }
            
            // æ·»åŠ æ–°æ•°æ®ç‚¹
            memoryHistory.push({
                process_memory: memoryUsage.rss_mb || memoryUsage,
                system_memory: memoryUsage.system_used_mb || 0,
                timestamp: timestamp
            });
            
            // ä¿æŒæœ€è¿‘1000ä¸ªæ•°æ®ç‚¹
            if (memoryHistory.length > 1000) {
                memoryHistory = memoryHistory.slice(-1000);
            }
            
            // æ›´æ–°å›¾è¡¨æ•°æ®
            memoryChart.data.labels = memoryHistory.map(point => 
                new Date(point.timestamp * 1000).toLocaleTimeString()
            );
            memoryChart.data.datasets[0].data = memoryHistory.map(point => point.process_memory);
            memoryChart.data.datasets[1].data = memoryHistory.map(point => point.system_memory);
            
            memoryChart.update();
        }
        
        // æ›´æ–°GPUå›¾è¡¨
        function updateGPUChart(gpuUsage, timestamp) {
            if (!gpuChart) {
                initGPUChart();
            }
            
            // å¦‚æœGPUä½¿ç”¨é‡ä¸ºnullæˆ–undefinedï¼Œè·³è¿‡æ›´æ–°
            if (gpuUsage === null || gpuUsage === undefined) {
                return;
            }
            
            // æ·»åŠ æ–°æ•°æ®ç‚¹
            gpuHistory.push({
                gpu: gpuUsage,
                timestamp: timestamp
            });
            
            // ä¿æŒæœ€è¿‘1000ä¸ªæ•°æ®ç‚¹
            if (gpuHistory.length > 1000) {
                gpuHistory = gpuHistory.slice(-1000);
            }
            
            // æ›´æ–°å›¾è¡¨æ•°æ®
            gpuChart.data.labels = gpuHistory.map(point => 
                new Date(point.timestamp * 1000).toLocaleTimeString()
            );
            gpuChart.data.datasets[0].data = gpuHistory.map(point => point.gpu);
            
            gpuChart.update();
        }
        
        // æ›´æ–°CPUå›¾è¡¨
        function updateCPUChart(cpuUsage, timestamp) {
            if (!cpuChart) {
                initCPUChart();
            }
            
            // æ·»åŠ æ–°æ•°æ®ç‚¹
            cpuHistory.push({
                process_cpu: cpuUsage.process_percent || 0,
                system_cpu: cpuUsage.system_percent || 0,
                timestamp: timestamp
            });
            
            // ä¿æŒæœ€è¿‘1000ä¸ªæ•°æ®ç‚¹
            if (cpuHistory.length > 1000) {
                cpuHistory = cpuHistory.slice(-1000);
            }
            
            // æ›´æ–°å›¾è¡¨æ•°æ®
            cpuChart.data.labels = cpuHistory.map(point => 
                new Date(point.timestamp * 1000).toLocaleTimeString()
            );
            cpuChart.data.datasets[0].data = cpuHistory.map(point => point.process_cpu);
            cpuChart.data.datasets[1].data = cpuHistory.map(point => point.system_cpu);
            
            cpuChart.update();
        }
        
        // æ›´æ–°GPUä¿¡æ¯æ˜¾ç¤º
        function updateGPUInfo(gpuInfo) {
            const gpuInfoDiv = document.getElementById('gpuInfo');
            const gpuStatsDiv = document.getElementById('gpuStats');
            
            if (!gpuInfo || !gpuInfo.available) {
                gpuInfoDiv.style.display = 'none';
                return;
            }
            
            gpuInfoDiv.style.display = 'block';
            
            let statsHTML = '';
            
            if (gpuInfo.name) {
                statsHTML += `
                    <div class="gpu-stat">
                        <div class="value">${gpuInfo.name}</div>
                        <div class="label">GPUåç§°</div>
                    </div>
                `;
            }
            
            if (gpuInfo.memory_total) {
                statsHTML += `
                    <div class="gpu-stat">
                        <div class="value">${(gpuInfo.memory_total / 1024).toFixed(1)}GB</div>
                        <div class="label">æ€»æ˜¾å­˜</div>
                    </div>
                `;
            }
            
            if (gpuInfo.memory_used) {
                statsHTML += `
                    <div class="gpu-stat">
                        <div class="value">${(gpuInfo.memory_used / 1024).toFixed(1)}GB</div>
                        <div class="label">å·²ç”¨æ˜¾å­˜</div>
                    </div>
                `;
            }
            
            if (gpuInfo.memory_free) {
                statsHTML += `
                    <div class="gpu-stat">
                        <div class="value">${(gpuInfo.memory_free / 1024).toFixed(1)}GB</div>
                        <div class="label">å¯ç”¨æ˜¾å­˜</div>
                    </div>
                `;
            }
            
            if (gpuInfo.memory_used && gpuInfo.memory_total) {
                const usagePercent = ((gpuInfo.memory_used / gpuInfo.memory_total) * 100).toFixed(1);
                statsHTML += `
                    <div class="gpu-stat">
                        <div class="value">${usagePercent}%</div>
                        <div class="label">æ˜¾å­˜ä½¿ç”¨ç‡</div>
                    </div>
                `;
            }
            
            if (gpuInfo.temperature) {
                statsHTML += `
                    <div class="gpu-stat">
                        <div class="value">${gpuInfo.temperature}Â°C</div>
                        <div class="label">æ¸©åº¦</div>
                    </div>
                `;
            }
            
            if (gpuInfo.utilization) {
                statsHTML += `
                    <div class="gpu-stat">
                        <div class="value">${gpuInfo.utilization}%</div>
                        <div class="label">åˆ©ç”¨ç‡</div>
                    </div>
                `;
            }
            
            gpuStatsDiv.innerHTML = statsHTML;
        }
        
        // æ›´æ–°ç³»ç»Ÿä¿¡æ¯æ˜¾ç¤º
        function updateSystemInfo(memoryInfo, cpuInfo, gpuInfo) {
            const systemInfoDiv = document.getElementById('systemInfo');
            
            let systemHTML = '<h4>ğŸ’» ç³»ç»Ÿèµ„æº</h4>';
            
            // CPUä¿¡æ¯
            if (cpuInfo) {
                systemHTML += `
                    <p><strong>CPU:</strong> ${cpuInfo.cpu_count} æ ¸å¿ƒ`;
                if (cpuInfo.cpu_freq) {
                    systemHTML += `, ${cpuInfo.cpu_freq.toFixed(1)} MHz`;
                }
                systemHTML += `</p>
                    <p><strong>CPUä½¿ç”¨ç‡:</strong> è¿›ç¨‹ ${cpuInfo.process_percent.toFixed(1)}%, ç³»ç»Ÿ ${cpuInfo.system_percent.toFixed(1)}%</p>
                `;
            }
            
            // å†…å­˜ä¿¡æ¯
            if (memoryInfo) {
                systemHTML += `
                    <p><strong>å†…å­˜:</strong> è¿›ç¨‹ ${memoryInfo.rss_mb.toFixed(1)}MB (${memoryInfo.percent.toFixed(1)}%), ç³»ç»Ÿ ${memoryInfo.system_used_mb.toFixed(1)}MB / ${memoryInfo.system_total_mb.toFixed(1)}MB (${memoryInfo.system_percent.toFixed(1)}%)</p>
                `;
            }
            
            // GPUä¿¡æ¯
            if (gpuInfo && gpuInfo.available) {
                systemHTML += `<p><strong>GPU:</strong> ${gpuInfo.name} (${gpuInfo.device_type.toUpperCase()})</p>`;
                if (gpuInfo.memory_used && gpuInfo.memory_total) {
                    const gpuUsagePercent = ((gpuInfo.memory_used / gpuInfo.memory_total) * 100).toFixed(1);
                    systemHTML += `<p><strong>GPUæ˜¾å­˜:</strong> ${gpuInfo.memory_used.toFixed(1)}MB / ${gpuInfo.memory_total.toFixed(1)}MB (${gpuUsagePercent}%)</p>`;
                }
            }
            
            systemInfoDiv.innerHTML = systemHTML;
        }
        
        async function checkHealth() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                const statusDiv = document.getElementById('healthStatus');
                
                if (data.status === 'healthy' || data.status === 'degraded') {
                    let statusClass = data.status === 'healthy' ? 'success' : 'info';
                    let statusIcon = data.status === 'healthy' ? 'âœ…' : 'âš ï¸';
                    
                    let statusHTML = `
                        <div class="status ${statusClass}">
                            ${statusIcon} æœåŠ¡${data.status === 'healthy' ? 'æ­£å¸¸' : 'é™çº§'}<br>
                            è¿è¡Œæ—¶é—´: ${data.uptime.toFixed(1)}s<br>
                            Workeræ•°é‡: ${data.workers.total} (å¯ç”¨: ${data.workers.available}, å¿™ç¢Œ: ${data.workers.busy})<br>
                            å†…å­˜ä½¿ç”¨: ${data.memory_usage_mb.toFixed(1)}MB<br>
                            è®¾å¤‡: ${data.device}<br>
                    `;
                    
                    // æ·»åŠ é˜Ÿåˆ—ä¿¡æ¯
                    if (data.queue) {
                        statusHTML += `
                            é˜Ÿåˆ—çŠ¶æ€: ${data.queue.size}/${data.queue.max_size}<br>
                        `;
                    }
                    
                    // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
                    if (data.statistics) {
                        statusHTML += `
                            æ€»è¯·æ±‚: ${data.statistics.total_requests}, 
                            æˆåŠŸ: ${data.statistics.successful_requests}, 
                            å¤±è´¥: ${data.statistics.failed_requests}<br>
                        `;
                    }
                    
                    statusHTML += `
                            æœ€åæ£€æŸ¥: ${new Date().toLocaleTimeString()}
                        </div>
                    `;
                    
                    statusDiv.innerHTML = statusHTML;
                    
                    // æ›´æ–°å†…å­˜ä½¿ç”¨å›¾è¡¨
                    updateMemoryChart(data.memory_usage, data.timestamp);
                    
                    // æ›´æ–°CPUä½¿ç”¨ç‡å›¾è¡¨
                    if (data.cpu_usage) {
                        updateCPUChart(data.cpu_usage, data.timestamp);
                    }
                    
                    // æ›´æ–°ç³»ç»Ÿä¿¡æ¯
                    updateSystemInfo(data.memory_usage, data.cpu_usage, data.gpu_info);
                    
                    // æ›´æ–°GPUä¿¡æ¯
                    if (data.gpu_info && data.gpu_info.available) {
                        isGPUAvailable = true;
                        updateGPUInfo(data.gpu_info);
                        
                        // æ›´æ–°GPUæ˜¾å­˜ä½¿ç”¨å›¾è¡¨
                        if (data.gpu_info.memory_used) {
                            updateGPUChart(data.gpu_info.memory_used, data.timestamp);
                        }
                    } else {
                        isGPUAvailable = false;
                        document.getElementById('gpuInfo').style.display = 'none';
                    }
                } else {
                    statusDiv.innerHTML = `
                        <div class="status error">
                            âŒ æœåŠ¡å¼‚å¸¸: ${data.error}<br>
                            æœ€åæ£€æŸ¥: ${new Date().toLocaleTimeString()}
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('healthStatus').innerHTML = `
                    <div class="status error">
                        âŒ è¯·æ±‚å¤±è´¥: ${error}<br>
                        æœ€åæ£€æŸ¥: ${new Date().toLocaleTimeString()}
                    </div>
                `;
            }
        }
        
        async function synthesize() {
            const text = document.getElementById('textInput').value;
            if (!text.trim()) {
                alert('è¯·è¾“å…¥æ–‡æœ¬');
                return;
            }
            
            try {
                const response = await fetch('/synthesize', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({text: text, speaker: 'default'})
                });
                
                const data = await response.json();
                const resultDiv = document.getElementById('synthesisResult');
                
                if (data.success) {
                    let resultHTML = `
                        <div class="status success">
                            âœ… åˆæˆæˆåŠŸ<br>
                            æ¨ç†æ—¶é—´: ${(data.data.inference_time * 1000).toFixed(1)}ms<br>
                            éŸ³é¢‘é•¿åº¦: ${data.data.audio.length} å­—ç¬¦
                    `;
                    
                    // æ·»åŠ å¼•æ“IDä¿¡æ¯
                    if (data.data.engine_id !== undefined) {
                        resultHTML += `<br>ä½¿ç”¨å¼•æ“: ${data.data.engine_id}`;
                    }
                    
                    resultHTML += `</div>`;
                    resultDiv.innerHTML = resultHTML;
                    
                    // æ’­æ”¾éŸ³é¢‘
                    const audio = document.getElementById('audioPlayer');
                    audio.src = 'data:audio/wav;base64,' + data.data.audio;
                    audio.style.display = 'block';
                } else {
                    resultDiv.innerHTML = `<div class="status error">âŒ åˆæˆå¤±è´¥: ${data.error}</div>`;
                }
            } catch (error) {
                document.getElementById('synthesisResult').innerHTML = `<div class="status error">âŒ è¯·æ±‚å¤±è´¥: ${error}</div>`;
            }
        }
        
        function startAutoHealthCheck() {
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (healthCheckInterval) {
                clearInterval(healthCheckInterval);
            }
            
            // ç«‹å³æ‰§è¡Œä¸€æ¬¡å¥åº·æ£€æŸ¥
            checkHealth();
            
            // æ¯5ç§’è‡ªåŠ¨æ£€æŸ¥ä¸€æ¬¡
            healthCheckInterval = setInterval(checkHealth, 5000);
        }
        
        function stopAutoHealthCheck() {
            if (healthCheckInterval) {
                clearInterval(healthCheckInterval);
                healthCheckInterval = null;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶å¯åŠ¨è‡ªåŠ¨å¥åº·æ£€æŸ¥
        window.onload = function() {
            startAutoHealthCheck();
        };
        
        // é¡µé¢å¸è½½æ—¶æ¸…é™¤å®šæ—¶å™¨
        window.onbeforeunload = function() {
            stopAutoHealthCheck();
        };
    </script>
</body>
</html> 