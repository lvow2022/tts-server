<!DOCTYPE html>
<html>
<head>
    <title>TTS Server æµ‹è¯•é¡µé¢</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        input, textarea, button { margin: 5px; padding: 8px; }
        textarea { width: 100%; height: 100px; }
        button { background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .status { padding: 10px; margin: 10px 0; border-radius: 3px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .auto-check { font-size: 12px; color: #666; margin-top: 5px; }
        .chart-container { margin: 20px 0; }
        .chart { width: 100%; height: 300px; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤ TTS Server æµ‹è¯•é¡µé¢</h1>
        
        <div class="section">
            <h3>ğŸ“Š æœåŠ¡çŠ¶æ€</h3>
            <button onclick="checkHealth()">æ£€æŸ¥å¥åº·çŠ¶æ€</button>
            <div id="healthStatus"></div>
            <div class="auto-check">â° æ¯5ç§’è‡ªåŠ¨æ£€æŸ¥æœåŠ¡çŠ¶æ€</div>
        </div>
        
        <div class="section">
            <div class="chart-container">
                <canvas id="memoryChart" class="chart"></canvas>
            </div>
        </div>
        
        <div class="section">
            <h3>ğŸµ è¯­éŸ³åˆæˆæµ‹è¯•</h3>
            <textarea id="textInput" placeholder="è¯·è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬...">ä½ å¥½ï¼Œè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ã€‚</textarea>
            <br>
            <button onclick="synthesize()">åˆæˆè¯­éŸ³</button>
            <div id="synthesisResult"></div>
            <audio id="audioPlayer" controls style="display:none;"></audio>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let healthCheckInterval = null;
        let memoryHistory = []; // å­˜å‚¨å†…å­˜ä½¿ç”¨å†å²
        let chart = null;
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            const ctx = document.getElementById('memoryChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'å†…å­˜ä½¿ç”¨ (MB)',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'å†…å­˜ä½¿ç”¨ (MB)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¶é—´'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'å†…å­˜ä½¿ç”¨è¶‹åŠ¿å›¾'
                        }
                    }
                }
            });
        }
        
        // æ›´æ–°å›¾è¡¨
        function updateChart(memoryUsage, timestamp) {
            if (!chart) {
                initChart();
            }
            
            // æ·»åŠ æ–°æ•°æ®ç‚¹
            memoryHistory.push({
                memory: memoryUsage,
                timestamp: timestamp
            });
            
            // ä¿æŒæœ€è¿‘1000ä¸ªæ•°æ®ç‚¹
            if (memoryHistory.length > 1000) {
                memoryHistory = memoryHistory.slice(-1000);
            }
            
            // æ›´æ–°å›¾è¡¨æ•°æ®
            chart.data.labels = memoryHistory.map(point => 
                new Date(point.timestamp * 1000).toLocaleTimeString()
            );
            chart.data.datasets[0].data = memoryHistory.map(point => point.memory);
            
            chart.update();
        }
        
        async function checkHealth() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                const statusDiv = document.getElementById('healthStatus');
                
                if (data.status === 'healthy') {
                    statusDiv.innerHTML = `
                        <div class="status success">
                            âœ… æœåŠ¡æ­£å¸¸<br>
                            è¿è¡Œæ—¶é—´: ${data.uptime.toFixed(1)}s<br>
                            Workeræ•°é‡: ${data.workers}<br>
                            å†…å­˜ä½¿ç”¨: ${data.memory_usage_mb.toFixed(1)}MB<br>
                            è®¾å¤‡: ${data.device}<br>
                            æœ€åæ£€æŸ¥: ${new Date().toLocaleTimeString()}
                        </div>
                    `;
                    
                    // æ›´æ–°å†…å­˜ä½¿ç”¨å›¾è¡¨
                    updateChart(data.memory_usage_mb, data.timestamp);
                } else {
                    statusDiv.innerHTML = `
                        <div class="status error">
                            âŒ æœåŠ¡å¼‚å¸¸: ${data.error}<br>
                            æœ€åæ£€æŸ¥: ${new Date().toLocaleTimeString()}
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('healthStatus').innerHTML = `
                    <div class="status error">
                        âŒ è¯·æ±‚å¤±è´¥: ${error}<br>
                        æœ€åæ£€æŸ¥: ${new Date().toLocaleTimeString()}
                    </div>
                `;
            }
        }
        
        async function synthesize() {
            const text = document.getElementById('textInput').value;
            if (!text.trim()) {
                alert('è¯·è¾“å…¥æ–‡æœ¬');
                return;
            }
            
            try {
                const response = await fetch('/synthesize', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({text: text, speaker: 'default'})
                });
                
                const data = await response.json();
                const resultDiv = document.getElementById('synthesisResult');
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="status success">
                            âœ… åˆæˆæˆåŠŸ<br>
                            æ¨ç†æ—¶é—´: ${(data.data.inference_time * 1000).toFixed(1)}ms<br>
                            éŸ³é¢‘é•¿åº¦: ${data.data.audio.length} å­—ç¬¦
                        </div>
                    `;
                    
                    // æ’­æ”¾éŸ³é¢‘
                    const audio = document.getElementById('audioPlayer');
                    audio.src = 'data:audio/wav;base64,' + data.data.audio;
                    audio.style.display = 'block';
                } else {
                    resultDiv.innerHTML = `<div class="status error">âŒ åˆæˆå¤±è´¥: ${data.error}</div>`;
                }
            } catch (error) {
                document.getElementById('synthesisResult').innerHTML = `<div class="status error">âŒ è¯·æ±‚å¤±è´¥: ${error}</div>`;
            }
        }
        
        function startAutoHealthCheck() {
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (healthCheckInterval) {
                clearInterval(healthCheckInterval);
            }
            
            // ç«‹å³æ‰§è¡Œä¸€æ¬¡å¥åº·æ£€æŸ¥
            checkHealth();
            
            // æ¯5ç§’è‡ªåŠ¨æ£€æŸ¥ä¸€æ¬¡
            healthCheckInterval = setInterval(checkHealth, 5000);
        }
        
        function stopAutoHealthCheck() {
            if (healthCheckInterval) {
                clearInterval(healthCheckInterval);
                healthCheckInterval = null;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶å¯åŠ¨è‡ªåŠ¨å¥åº·æ£€æŸ¥
        window.onload = function() {
            startAutoHealthCheck();
        };
        
        // é¡µé¢å¸è½½æ—¶æ¸…é™¤å®šæ—¶å™¨
        window.onbeforeunload = function() {
            stopAutoHealthCheck();
        };
    </script>
</body>
</html> 