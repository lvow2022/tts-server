<!DOCTYPE html>
<html>
<head>
    <title>TTS Server 测试页面</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        input, textarea, button { margin: 5px; padding: 8px; }
        textarea { width: 100%; height: 100px; }
        button { background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .status { padding: 10px; margin: 10px 0; border-radius: 3px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .auto-check { font-size: 12px; color: #666; margin-top: 5px; }
        .chart-container { margin: 20px 0; }
        .chart { width: 100%; height: 300px; border: 1px solid #ddd; }
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .chart-section { margin: 20px 0; }
        .gpu-info { background: #e7f3ff; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .gpu-info h4 { margin: 0 0 10px 0; color: #0056b3; }
        .gpu-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .gpu-stat { background: white; padding: 8px; border-radius: 3px; text-align: center; }
        .gpu-stat .value { font-size: 18px; font-weight: bold; color: #007bff; }
        .gpu-stat .label { font-size: 12px; color: #666; }
        .system-info { background: #f0f9eb; padding: 10px; border-radius: 5px; margin-top: 20px; }
        .system-info h4 { margin: 0 0 10px 0; color: #67c23a; }
        .system-info p { margin: 5px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎤 TTS Server 测试页面</h1>
        
        <div class="section">
            <h3>📊 服务状态</h3>
            <button onclick="checkHealth()">检查健康状态</button>
            <div id="healthStatus"></div>
            <div class="auto-check">⏰ 每5秒自动检查服务状态</div>
        </div>
        
        <div class="section">
            <h3>📈 系统监控</h3>
            <div class="charts-grid">
                <div class="chart-section">
                    <h4>内存使用趋势</h4>
                    <div class="chart-container">
                        <canvas id="memoryChart" class="chart"></canvas>
                    </div>
                </div>
                <div class="chart-section">
                    <h4>GPU显存使用趋势</h4>
                    <div class="chart-container">
                        <canvas id="gpuChart" class="chart"></canvas>
                    </div>
                </div>
            </div>
            <div class="charts-grid">
                <div class="chart-section">
                    <h4>CPU使用率趋势</h4>
                    <div class="chart-container">
                        <canvas id="cpuChart" class="chart"></canvas>
                    </div>
                </div>
                <div class="chart-section">
                    <h4>系统资源概览</h4>
                    <div id="systemInfo" class="system-info"></div>
                </div>
            </div>
            <div id="gpuInfo" class="gpu-info" style="display: none;">
                <h4>🎮 GPU 信息</h4>
                <div class="gpu-stats" id="gpuStats"></div>
            </div>
        </div>
        
        <div class="section">
            <h3>🎵 语音合成测试</h3>
            <textarea id="textInput" placeholder="请输入要合成的文本...">你好，这是一个测试。</textarea>
            <br>
            <button onclick="synthesize()">合成语音</button>
            <div id="synthesisResult"></div>
            <audio id="audioPlayer" controls style="display:none;"></audio>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let healthCheckInterval = null;
        let memoryHistory = []; // 存储内存使用历史
        let gpuHistory = []; // 存储GPU显存使用历史
        let cpuHistory = []; // 存储CPU使用率历史
        let memoryChart = null;
        let gpuChart = null;
        let cpuChart = null;
        let isGPUAvailable = false;
        
        // 初始化内存图表
        function initMemoryChart() {
            const ctx = document.getElementById('memoryChart').getContext('2d');
            memoryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '进程内存使用 (MB)',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }, {
                        label: '系统内存使用 (MB)',
                        data: [],
                        borderColor: 'rgb(255, 159, 64)',
                        backgroundColor: 'rgba(255, 159, 64, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '内存使用 (MB)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '时间'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '内存使用趋势图'
                        }
                    }
                }
            });
        }
        
        // 初始化GPU图表
        function initGPUChart() {
            const ctx = document.getElementById('gpuChart').getContext('2d');
            gpuChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'GPU显存使用 (MB)',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'GPU显存使用 (MB)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '时间'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'GPU显存使用趋势图'
                        }
                    }
                }
            });
        }
        
        // 初始化CPU图表
        function initCPUChart() {
            const ctx = document.getElementById('cpuChart').getContext('2d');
            cpuChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '进程CPU使用率 (%)',
                        data: [],
                        borderColor: 'rgb(153, 102, 255)',
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        tension: 0.1
                    }, {
                        label: '系统CPU使用率 (%)',
                        data: [],
                        borderColor: 'rgb(255, 205, 86)',
                        backgroundColor: 'rgba(255, 205, 86, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'CPU使用率 (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '时间'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'CPU使用率趋势图'
                        }
                    }
                }
            });
        }
        
        // 更新内存图表
        function updateMemoryChart(memoryUsage, timestamp) {
            if (!memoryChart) {
                initMemoryChart();
            }
            
            // 添加新数据点
            memoryHistory.push({
                process_memory: memoryUsage.rss_mb || memoryUsage,
                system_memory: memoryUsage.system_used_mb || 0,
                timestamp: timestamp
            });
            
            // 保持最近1000个数据点
            if (memoryHistory.length > 1000) {
                memoryHistory = memoryHistory.slice(-1000);
            }
            
            // 更新图表数据
            memoryChart.data.labels = memoryHistory.map(point => 
                new Date(point.timestamp * 1000).toLocaleTimeString()
            );
            memoryChart.data.datasets[0].data = memoryHistory.map(point => point.process_memory);
            memoryChart.data.datasets[1].data = memoryHistory.map(point => point.system_memory);
            
            memoryChart.update();
        }
        
        // 更新GPU图表
        function updateGPUChart(gpuUsage, timestamp) {
            if (!gpuChart) {
                initGPUChart();
            }
            
            // 如果GPU使用量为null或undefined，跳过更新
            if (gpuUsage === null || gpuUsage === undefined) {
                return;
            }
            
            // 添加新数据点
            gpuHistory.push({
                gpu: gpuUsage,
                timestamp: timestamp
            });
            
            // 保持最近1000个数据点
            if (gpuHistory.length > 1000) {
                gpuHistory = gpuHistory.slice(-1000);
            }
            
            // 更新图表数据
            gpuChart.data.labels = gpuHistory.map(point => 
                new Date(point.timestamp * 1000).toLocaleTimeString()
            );
            gpuChart.data.datasets[0].data = gpuHistory.map(point => point.gpu);
            
            gpuChart.update();
        }
        
        // 更新CPU图表
        function updateCPUChart(cpuUsage, timestamp) {
            if (!cpuChart) {
                initCPUChart();
            }
            
            // 添加新数据点
            cpuHistory.push({
                process_cpu: cpuUsage.process_percent || 0,
                system_cpu: cpuUsage.system_percent || 0,
                timestamp: timestamp
            });
            
            // 保持最近1000个数据点
            if (cpuHistory.length > 1000) {
                cpuHistory = cpuHistory.slice(-1000);
            }
            
            // 更新图表数据
            cpuChart.data.labels = cpuHistory.map(point => 
                new Date(point.timestamp * 1000).toLocaleTimeString()
            );
            cpuChart.data.datasets[0].data = cpuHistory.map(point => point.process_cpu);
            cpuChart.data.datasets[1].data = cpuHistory.map(point => point.system_cpu);
            
            cpuChart.update();
        }
        
        // 更新GPU信息显示
        function updateGPUInfo(gpuInfo) {
            const gpuInfoDiv = document.getElementById('gpuInfo');
            const gpuStatsDiv = document.getElementById('gpuStats');
            
            if (!gpuInfo || !gpuInfo.available) {
                gpuInfoDiv.style.display = 'none';
                return;
            }
            
            gpuInfoDiv.style.display = 'block';
            
            let statsHTML = '';
            
            if (gpuInfo.name) {
                statsHTML += `
                    <div class="gpu-stat">
                        <div class="value">${gpuInfo.name}</div>
                        <div class="label">GPU名称</div>
                    </div>
                `;
            }
            
            if (gpuInfo.memory_total) {
                statsHTML += `
                    <div class="gpu-stat">
                        <div class="value">${(gpuInfo.memory_total / 1024).toFixed(1)}GB</div>
                        <div class="label">总显存</div>
                    </div>
                `;
            }
            
            if (gpuInfo.memory_used) {
                statsHTML += `
                    <div class="gpu-stat">
                        <div class="value">${(gpuInfo.memory_used / 1024).toFixed(1)}GB</div>
                        <div class="label">已用显存</div>
                    </div>
                `;
            }
            
            if (gpuInfo.memory_free) {
                statsHTML += `
                    <div class="gpu-stat">
                        <div class="value">${(gpuInfo.memory_free / 1024).toFixed(1)}GB</div>
                        <div class="label">可用显存</div>
                    </div>
                `;
            }
            
            if (gpuInfo.memory_used && gpuInfo.memory_total) {
                const usagePercent = ((gpuInfo.memory_used / gpuInfo.memory_total) * 100).toFixed(1);
                statsHTML += `
                    <div class="gpu-stat">
                        <div class="value">${usagePercent}%</div>
                        <div class="label">显存使用率</div>
                    </div>
                `;
            }
            
            if (gpuInfo.temperature) {
                statsHTML += `
                    <div class="gpu-stat">
                        <div class="value">${gpuInfo.temperature}°C</div>
                        <div class="label">温度</div>
                    </div>
                `;
            }
            
            if (gpuInfo.utilization) {
                statsHTML += `
                    <div class="gpu-stat">
                        <div class="value">${gpuInfo.utilization}%</div>
                        <div class="label">利用率</div>
                    </div>
                `;
            }
            
            gpuStatsDiv.innerHTML = statsHTML;
        }
        
        // 更新系统信息显示
        function updateSystemInfo(memoryInfo, cpuInfo, gpuInfo) {
            const systemInfoDiv = document.getElementById('systemInfo');
            
            let systemHTML = '<h4>💻 系统资源</h4>';
            
            // CPU信息
            if (cpuInfo) {
                systemHTML += `
                    <p><strong>CPU:</strong> ${cpuInfo.cpu_count} 核心`;
                if (cpuInfo.cpu_freq) {
                    systemHTML += `, ${cpuInfo.cpu_freq.toFixed(1)} MHz`;
                }
                systemHTML += `</p>
                    <p><strong>CPU使用率:</strong> 进程 ${cpuInfo.process_percent.toFixed(1)}%, 系统 ${cpuInfo.system_percent.toFixed(1)}%</p>
                `;
            }
            
            // 内存信息
            if (memoryInfo) {
                systemHTML += `
                    <p><strong>内存:</strong> 进程 ${memoryInfo.rss_mb.toFixed(1)}MB (${memoryInfo.percent.toFixed(1)}%), 系统 ${memoryInfo.system_used_mb.toFixed(1)}MB / ${memoryInfo.system_total_mb.toFixed(1)}MB (${memoryInfo.system_percent.toFixed(1)}%)</p>
                `;
            }
            
            // GPU信息
            if (gpuInfo && gpuInfo.available) {
                systemHTML += `<p><strong>GPU:</strong> ${gpuInfo.name} (${gpuInfo.device_type.toUpperCase()})</p>`;
                if (gpuInfo.memory_used && gpuInfo.memory_total) {
                    const gpuUsagePercent = ((gpuInfo.memory_used / gpuInfo.memory_total) * 100).toFixed(1);
                    systemHTML += `<p><strong>GPU显存:</strong> ${gpuInfo.memory_used.toFixed(1)}MB / ${gpuInfo.memory_total.toFixed(1)}MB (${gpuUsagePercent}%)</p>`;
                }
            }
            
            systemInfoDiv.innerHTML = systemHTML;
        }
        
        async function checkHealth() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                const statusDiv = document.getElementById('healthStatus');
                
                if (data.status === 'healthy' || data.status === 'degraded') {
                    let statusClass = data.status === 'healthy' ? 'success' : 'info';
                    let statusIcon = data.status === 'healthy' ? '✅' : '⚠️';
                    
                    let statusHTML = `
                        <div class="status ${statusClass}">
                            ${statusIcon} 服务${data.status === 'healthy' ? '正常' : '降级'}<br>
                            运行时间: ${data.uptime.toFixed(1)}s<br>
                            Worker数量: ${data.workers.total} (可用: ${data.workers.available}, 忙碌: ${data.workers.busy})<br>
                            内存使用: ${data.memory_usage_mb.toFixed(1)}MB<br>
                            设备: ${data.device}<br>
                    `;
                    
                    // 添加队列信息
                    if (data.queue) {
                        statusHTML += `
                            队列状态: ${data.queue.size}/${data.queue.max_size}<br>
                        `;
                    }
                    
                    // 添加统计信息
                    if (data.statistics) {
                        statusHTML += `
                            总请求: ${data.statistics.total_requests}, 
                            成功: ${data.statistics.successful_requests}, 
                            失败: ${data.statistics.failed_requests}<br>
                        `;
                    }
                    
                    statusHTML += `
                            最后检查: ${new Date().toLocaleTimeString()}
                        </div>
                    `;
                    
                    statusDiv.innerHTML = statusHTML;
                    
                    // 更新内存使用图表
                    updateMemoryChart(data.memory_usage, data.timestamp);
                    
                    // 更新CPU使用率图表
                    if (data.cpu_usage) {
                        updateCPUChart(data.cpu_usage, data.timestamp);
                    }
                    
                    // 更新系统信息
                    updateSystemInfo(data.memory_usage, data.cpu_usage, data.gpu_info);
                    
                    // 更新GPU信息
                    if (data.gpu_info && data.gpu_info.available) {
                        isGPUAvailable = true;
                        updateGPUInfo(data.gpu_info);
                        
                        // 更新GPU显存使用图表
                        if (data.gpu_info.memory_used) {
                            updateGPUChart(data.gpu_info.memory_used, data.timestamp);
                        }
                    } else {
                        isGPUAvailable = false;
                        document.getElementById('gpuInfo').style.display = 'none';
                    }
                } else {
                    statusDiv.innerHTML = `
                        <div class="status error">
                            ❌ 服务异常: ${data.error}<br>
                            最后检查: ${new Date().toLocaleTimeString()}
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('healthStatus').innerHTML = `
                    <div class="status error">
                        ❌ 请求失败: ${error}<br>
                        最后检查: ${new Date().toLocaleTimeString()}
                    </div>
                `;
            }
        }
        
        async function synthesize() {
            const text = document.getElementById('textInput').value;
            if (!text.trim()) {
                alert('请输入文本');
                return;
            }
            
            try {
                const response = await fetch('/synthesize', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({text: text, speaker: 'default'})
                });
                
                const data = await response.json();
                const resultDiv = document.getElementById('synthesisResult');
                
                if (data.success) {
                    let resultHTML = `
                        <div class="status success">
                            ✅ 合成成功<br>
                            推理时间: ${(data.data.inference_time * 1000).toFixed(1)}ms<br>
                            音频长度: ${data.data.audio.length} 字符
                    `;
                    
                    // 添加引擎ID信息
                    if (data.data.engine_id !== undefined) {
                        resultHTML += `<br>使用引擎: ${data.data.engine_id}`;
                    }
                    
                    resultHTML += `</div>`;
                    resultDiv.innerHTML = resultHTML;
                    
                    // 播放音频
                    const audio = document.getElementById('audioPlayer');
                    audio.src = 'data:audio/wav;base64,' + data.data.audio;
                    audio.style.display = 'block';
                } else {
                    resultDiv.innerHTML = `<div class="status error">❌ 合成失败: ${data.error}</div>`;
                }
            } catch (error) {
                document.getElementById('synthesisResult').innerHTML = `<div class="status error">❌ 请求失败: ${error}</div>`;
            }
        }
        
        function startAutoHealthCheck() {
            // 清除之前的定时器
            if (healthCheckInterval) {
                clearInterval(healthCheckInterval);
            }
            
            // 立即执行一次健康检查
            checkHealth();
            
            // 每5秒自动检查一次
            healthCheckInterval = setInterval(checkHealth, 5000);
        }
        
        function stopAutoHealthCheck() {
            if (healthCheckInterval) {
                clearInterval(healthCheckInterval);
                healthCheckInterval = null;
            }
        }
        
        // 页面加载时启动自动健康检查
        window.onload = function() {
            startAutoHealthCheck();
        };
        
        // 页面卸载时清除定时器
        window.onbeforeunload = function() {
            stopAutoHealthCheck();
        };
    </script>
</body>
</html> 